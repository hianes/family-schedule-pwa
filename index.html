<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Í∞ÄÏ°± ÏãúÍ∞ÑÌëú - Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Ïö∞Î¶¨ Í∞ÄÏ°±Ïùò ÏãúÍ∞ÑÌëú - Google SheetsÏôÄ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî, 4Îì±Î∂Ñ Í≥†Ï†ï Î†àÏù¥ÏïÑÏõÉ">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Í∞ÄÏ°±ÏãúÍ∞ÑÌëú">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Favicon & App Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNCIgZmlsbD0iIzIxOTZGMyIvPgo8cGF0aCBkPSJNOCAzaDJWMWgydjJoNFYxaDJ2Mmg0VjFoMnYyaDJjMS4xIDAgMi45IDIgLjkgMkwyNCAxM3Y3YzAgMS4xLS45IDItMiAySDEwYy0xLjEgMC0yLS45LTItMlYxM2MwLTEuMS45LTItMi0yem0wIDEySDEwdjhoMTJWMTN6IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4=">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjAiIGZpbGw9IiMyMTk2RjMiLz4KPHN2ZyB4PSI0NSIgeT0iNDUiIHdpZHRoPSI5MCIgaGVpZ2h0PSI5MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xOSAzaC0xVjFoLTJ2Mkg4VjFINnYySDVjLTEuMTEgMC0xLjk5Ljg5LTEuOTkgMkwzIDVWMTljMCAxLjEuODkgMiAyIDJoMTRjMS4xIDAgMi0uOSAyLTJWNWMwLTEuMTEtLjg5LTItMi0yem0wIDE2SDVWOGgxNHYxMXoiLz4KPC9zdmc+Cjwvc3ZnPg==">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding-top: 50px;
            background: #f8f9fa;
        }
        
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #2196f3;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-text {
            font-weight: 500;
        }
        
        .refresh-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        
        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .status-success { color: #4caf50; }
        .status-error { color: #f44336; }
        .status-warning { color: #ff9800; }
        
        .container {
            margin: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .week-info {
            font-size: 18px;
            color: #666;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .week-navigation {
            display: flex !important; /* Í∞ïÏ†ú ÌëúÏãú */
            gap: 10px;
            align-items: center;
            visibility: visible !important; /* Í∞ïÏ†ú ÌëúÏãú */
            opacity: 1 !important; /* Í∞ïÏ†ú ÌëúÏãú */
        }
        
        .week-nav-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .week-nav-btn:hover {
            background: #1976d2;
        }
        
        .week-nav-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .current-week {
            font-weight: bold;
            color: #2196f3;
        }
        
        .memo-guide {
            background: #e8f4fd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .memo-guide h3 {
            margin: 0 0 15px 0;
            color: #1976d2;
            font-size: 16px;
        }
        
        .member-memo {
            margin-bottom: 10px;
            background: rgba(255,255,255,0.7);
            padding: 10px;
            border-radius: 6px;
        }
        
        .memo-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }
        
        .member-name {
            font-weight: 600;
            font-size: 14px;
        }
        
        .memo-content {
            font-size: 12px;
            color: #555;
            padding-left: 28px;
            line-height: 1.6;
            word-break: break-word;
        }
        
        .timetable {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        
        th {
            background: #f1f3f4;
            padding: 8px 4px;
            font-weight: 600;
            text-align: center;
            border-bottom: 2px solid #e0e0e0;
            font-size: 12px;
        }
        
        .time-col {
            background: #fafafa;
            width: 70px;
            font-weight: 500;
            color: #666;
            text-align: center;
            font-size: 10px;
            padding: 2px;
        }
        
        td {
            padding: 0;
            border: 1px solid #e8e8e8;
            height: 20px;
            vertical-align: middle;
            position: relative;
        }
        
        .time-slot {
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .empty-slot {
            position: absolute;
            height: calc(100% - 1px);
            top: 0.5px;
        }
        
        .event-bar {
            position: absolute;
            height: calc(100% + 2px);
            top: -1px;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 500;
            color: white;
            text-shadow: 0 1px 1px rgba(0,0,0,0.3);
            z-index: 20;
            overflow: hidden;
            white-space: nowrap;
            box-sizing: border-box;
        }
        
        .dad-bar { background: linear-gradient(135deg, #D6E3FF, #C2D2FF); color: black; }
        .mom-bar { background: linear-gradient(135deg, #FFD6ED, #FFC2E0); color: black; }
        .child1-bar { background: linear-gradient(135deg, #D6ECFF, #C2E0FF); color: black; }
        .child2-bar { background: linear-gradient(135deg, #E8F5D2, #D4E8B8); color: black; }
        
        .family-common {
            background: linear-gradient(135deg, #FFF3C4, #FFECB3) !important;
            color: black;
        }
        
        .multi-participant {
            background: linear-gradient(135deg, #FFE4B5, #FFDAB9) !important;
            color: black;
            border: 1px solid #FFB366;
        }
        
        .bar-start { 
            border-top-left-radius: 8px; 
            border-top-right-radius: 8px; 
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .bar-middle { 
            border-radius: 0; 
        }
        .bar-end { 
            border-bottom-left-radius: 8px; 
            border-bottom-right-radius: 8px; 
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
        .bar-single { 
            border-radius: 8px; 
        }
        
        .event-text,
        .large-text {
            display: block;
        }
        
        .large-text {
            display: flex !important;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .color-box {
            width: 20px;
            height: 12px;
            border-radius: 6px;
        }
        
        .hour-line {
            border-top: 2px solid #ddd;
        }
        
        .export-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 13px;
            color: #666;
            text-align: center;
        }
        
        .event-text {
            color: black !important;
            font-weight: 600;
            font-size: 9px;
            padding: 1px 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-shadow: 0 0 2px rgba(255,255,255,0.6);
        }
        
        .large-text {
            color: black !important;
            text-shadow: 0 0 3px rgba(255,255,255,0.8) !important;
            white-space: normal !important;
            text-align: center !important;
            line-height: 1.1 !important;
            font-weight: 700 !important;
            word-break: keep-all !important;
            overflow-wrap: break-word !important;
            padding: 1px 2px !important;
            overflow: visible !important;
            text-overflow: unset !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            height: 100% !important;
        }
        
        @media (max-width: 768px) {
            table { font-size: 9px; }
            td { height: 18px; }
            .event-bar { font-size: 8px; }
        }
        
        /* üì± PWA ÏÑ§Ïπò ÏïåÎ¶º Ïï†ÎãàÎ©îÏù¥ÏÖò */
        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* PWA ÏÑ§Ïπò Î≤ÑÌäº Ìò∏Î≤Ñ Ìö®Í≥º */
        #install-btn:hover {
            background: rgba(255,255,255,0.3) !important;
            transform: scale(1.05);
            transition: all 0.2s ease;
        }
    </style>
    
    <!-- üîê Í∞ÄÏ°± Ï†ÑÏö© Ïù∏Ï¶ù ÏãúÏä§ÌÖú (Í∞ÑÎã® Î≤ÑÏ†Ñ) -->
    <script>
        // üîë Í∞ÄÏ°± Ìå®Ïä§ÏõåÎìú ÌôïÏù∏
        (function() {
            const FAMILY_PASSWORD = 'kim2024family';
            const AUTH_KEY = 'familyScheduleAuth';
            
            // Ïù∏Ï¶ù ÏÉÅÌÉú ÌôïÏù∏
            if (localStorage.getItem(AUTH_KEY) !== 'verified') {
                // üîê Ïù∏Ï¶ù ÌïÑÏöî
                const password = prompt('üîê ÍπÄÏî® Í∞ÄÏ°± ÏãúÍ∞ÑÌëú\n\nÍ∞ÄÏ°± Íµ¨ÏÑ±ÏõêÎßå Ï†ëÍ∑º Í∞ÄÎä•Ìï©ÎãàÎã§.\nÏ†ëÍ∑º ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
                
                if (password === FAMILY_PASSWORD) {
                    // ‚úÖ Ïù∏Ï¶ù ÏÑ±Í≥µ
                    localStorage.setItem(AUTH_KEY, 'verified');
                    localStorage.setItem('familyAuthDate', new Date().toISOString());
                    alert('üéâ ÌôòÏòÅÌï©ÎãàÎã§! ÍπÄÏî® Í∞ÄÏ°± ÏãúÍ∞ÑÌëúÏûÖÎãàÎã§.\n\nüí° Ìôà ÌôîÎ©¥Ïóê Ï∂îÍ∞ÄÌïòÏó¨ Ïï±Ï≤òÎüº ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî!');
                } else {
                    // ‚ùå Ïù∏Ï¶ù Ïã§Ìå®
                    alert('‚ùå Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏùÄ Ï†ëÍ∑º ÏΩîÎìúÏûÖÎãàÎã§.\nÍ∞ÄÏ°± Íµ¨ÏÑ±ÏõêÎßå Ï†ëÍ∑ºÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                    document.body.innerHTML = '<div style="text-align:center; margin-top:20%; font-size:18px; color:#666;">Ï†ëÍ∑º Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§</div>';
                    throw new Error('Authentication failed');
                }
            }
        })();
    </script>
</head>
<body>
    <!-- PWA ÏÉÅÌÉúÎ∞î -->
    <div class="status-bar">
        <div class="status-text" id="status-text">üì± Í∞ÄÏ°± ÏãúÍ∞ÑÌëú Î°úÎî© Ï§ë...</div>
        <button class="refresh-btn" onclick="refreshSchedule()">üîÑ</button>
    </div>
    
    <div class="container">
        <div class="header">
            <h1>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Ïö∞Î¶¨ Í∞ÄÏ°± ÏãúÍ∞ÑÌëú</h1>
            <div class="week-info" id="week-info">
                <div class="current-week" id="current-week">2025ÎÖÑ 9Ïõî 1Ïùº ~ 9Ïõî 7Ïùº</div>
                <div class="week-navigation">
                    <button class="week-nav-btn" id="prev-week" onclick="changeWeek(-1)">‚óÄ Ïù¥Ï†Ñ Ï£º</button>
                    <button class="week-nav-btn" id="next-week" onclick="changeWeek(1)">Îã§Ïùå Ï£º ‚ñ∂</button>
                </div>
            </div>
        </div>
        
        <!-- Ï£ºÍ∞Ñ Î©îÎ™® & Ï§ÄÎπÑÏÇ¨Ìï≠ -->
        <div class="memo-guide" id="memo-guide">
            <h3>üìù Ï£ºÍ∞Ñ Î©îÎ™® & Ï§ÄÎπÑÏÇ¨Ìï≠</h3>
            <div id="memo-content">Î°úÎî© Ï§ë...</div>
        </div>
            
        <!-- Í∞ÄÏ°± Íµ¨ÏÑ±Ïõê ÏÉâÏÉÅ Î≤îÎ°Ä -->
        <div class="legend">
            <div class="legend-item">
                    <div class="color-box dad-bar"></div>
                <span>üë®‚Äçüíº ÏïÑÎπ†</span>
                </div>
            <div class="legend-item">
                    <div class="color-box mom-bar"></div>
                <span>üë©‚Äçüíº ÏóÑÎßà</span>
                </div>
            <div class="legend-item">
                    <div class="color-box child1-bar"></div>
                <span>üë¶ Ïú§Îπà</span>
                </div>
            <div class="legend-item">
                    <div class="color-box child2-bar"></div>
                <span>üëß Ïú§Ï§Ä</span>
                </div>
            <div class="legend-item">
                <div class="color-box" style="background: linear-gradient(135deg, #FF9800, #F57C00); border: 2px solid #FF5722;"></div>
                <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Í∞ÄÏ°±Í≥µÌÜµ</span>
            </div>
        </div>
        
        <!-- ÏãúÍ∞ÑÌëú -->
        <div class="timetable" id="timetable">
            <!-- ÏãúÍ∞ÑÌëú ÎÇ¥Ïö©Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
        </div>
        
        <div class="export-info">
            <strong>üì± 4Îì±Î∂Ñ Í≥†Ï†ï Î†àÏù¥ÏïÑÏõÉ ÏãúÍ∞ÑÌëú</strong><br>
            ‚Ä¢ Í∞Å Í∞ÄÏ°± Íµ¨ÏÑ±ÏõêÏùÄ Ìï≠ÏÉÅ Í∞ôÏùÄ ÏúÑÏπò(Ïπ∏)Ïóê Î∞∞Ïπò<br>
            ‚Ä¢ 30Î∂Ñ Îã®ÏúÑ Ï†ïÌôïÌïú ÏãúÍ∞Ñ Í¥ÄÎ¶¨<br>
            ‚Ä¢ Ïó∞ÏÜçÏÑ±Ïù¥ Ïú†ÏßÄÎêòÏñ¥ ÎçîÏö± Î≥¥Í∏∞ Ïâ¨ÏõÄ<br>
            ‚Ä¢ Google SheetsÏôÄ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî<br>
            <strong>ÏóÖÎç∞Ïù¥Ìä∏: <span id="update-time">Î°úÎî© Ï§ë...</span></strong>
                        </div>
                        </div>

    <script>
        // Google Sheets API ÏÑ§Ï†ï
        const GOOGLE_SHEETS_API_KEY = 'AIzaSyB1hBonIutQtlTPjOFJe-jD94jq0hETn0A';
        const SPREADSHEET_ID = '12PFdelBBPZzNbGW654fSf8-RG8fcRBNLKTpeyjG28Nc';
        const RANGE = 'ÏãúÌä∏1!A:M'; // 13Í∞ú Ïª¨Îüº (Date ÌïÑÎìú Ìè¨Ìï®)

        // ÌòÑÏû¨ Ï£º ÏÑ§Ï†ï (Ï£ºÍ∞Ñ Ïù¥Îèô Í∏∞Îä•) - Ï≤´ Î≤àÏß∏ Î∞òÎ≥µ ÏùºÏ†ï Ï£ºÍ∞ÑÏúºÎ°ú Ï¥àÍ∏∞Ìôî
        let currentWeek = new Date('2025-09-01'); // Ï≤´ Î≤àÏß∏ Î∞òÎ≥µÏùº(9Ïõî 2Ïùº) Ìè¨Ìï® Ï£ºÍ∞Ñ
        console.log('üöÄ Ï¥àÍ∏∞ currentWeek ÏÑ§Ï†ï (Ï≤´ Î≤àÏß∏ Î∞òÎ≥µ ÏùºÏ†ï Ï£ºÍ∞Ñ):', currentWeek.toDateString());
        
        // Í∞ÄÏ°± Íµ¨ÏÑ±Ïõê ÏÑ§Ï†ï
        const familyMembers = ['ÏïÑÎπ†', 'ÏóÑÎßà', 'Ïú§Îπà', 'Ïú§Ï§Ä'];
        const memberColors = {
            'ÏïÑÎπ†': 'dad-bar',
            'ÏóÑÎßà': 'mom-bar',
            'Ïú§Îπà': 'child1-bar',
            'Ïú§Ï§Ä': 'child2-bar',
            'Í∞ÄÏ°±Í≥µÌÜµ': 'family-common'
        };

        const memberIcons = {
            'ÏïÑÎπ†': 'üë®‚Äçüíº',
            'ÏóÑÎßà': 'üë©‚Äçüíº',
            'Ïú§Îπà': 'üë¶',
            'Ïú§Ï§Ä': 'üëß',
            'Í∞ÄÏ°±Í≥µÌÜµ': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶'
        };

        // ÏãúÍ∞Ñ Ïä¨Î°Ø ÏÉùÏÑ± (6:00-21:30, 30Î∂Ñ Îã®ÏúÑ)
        function generateTimeSlots() {
            const timeSlots = [];
            for (let hour = 6; hour <= 21; hour++) {
                timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
                if (hour < 21) {
                    timeSlots.push(`${hour.toString().padStart(2, '0')}:30`);
                }
            }
            timeSlots.push('21:30');
            return timeSlots;
        }

        // ÏãúÍ∞ÑÏùÑ Ïä¨Î°Ø Î≤àÌò∏Î°ú Î≥ÄÌôò
        function timeToSlot(timeStr) {
            if (!timeStr || timeStr === 'nan') return null;
            
            try {
                // ÏãúÍ∞Ñ ÌòïÏãù Ï†ïÍ∑úÌôî (7:30 -> 07:30)
                let normalizedTime = timeStr;
                if (timeStr.match(/^\d{1,2}:\d{2}$/)) {
                    const [hours, minutes] = timeStr.split(':');
                    normalizedTime = `${hours.padStart(2, '0')}:${minutes}`;
                }
                
                const [hour, minute] = normalizedTime.split(':').map(Number);
                return (hour - 6) * 2 + (minute >= 30 ? 1 : 0);
            } catch {
                return null;
            }
        }

        // Ï£ºÍ∞Ñ Ïù¥Îèô Ìï®Ïàò (ÏïàÏ†ÑÌïú DOM Ï°∞Ïûë)
        function changeWeek(direction) {
            try {
                console.log('üîÑ Ï£ºÍ∞Ñ Ïù¥Îèô ÏãúÎèÑ:', direction > 0 ? 'Îã§Ïùå Ï£º' : 'Ïù¥Ï†Ñ Ï£º');
                
                // ÏÉàÎ°úÏö¥ Date Í∞ùÏ≤¥ ÏÉùÏÑ± (ÏõêÎ≥∏ Î≥ÄÍ≤Ω Î∞©ÏßÄ)
                const newWeek = new Date(currentWeek);
                newWeek.setDate(newWeek.getDate() + (direction * 7));
                currentWeek = newWeek;
                
                console.log('‚úÖ currentWeek ÏóÖÎç∞Ïù¥Ìä∏Îê®:', currentWeek.toDateString());
                
                // Ï£ºÍ∞Ñ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                updateWeekDisplay();
                
                // ÏãúÍ∞ÑÌëú ÏÉàÎ°úÍ≥†Ïπ®
                if (typeof updateTimetable === 'function') {
                    updateTimetable();
                    console.log('‚úÖ ÏãúÍ∞ÑÌëú ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                } else {
                    console.warn('‚ö†Ô∏è updateTimetable Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                }
                
            } catch (error) {
                console.error('‚ùå changeWeek Ïò§Î•ò:', error);
            }
        }
        
        // Ï£ºÍ∞Ñ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏ (ÏïàÏ†ÑÌïú DOM Ï°∞Ïûë)
        function updateWeekDisplay() {
            try {
                const startOfWeek = new Date(currentWeek);
                const endOfWeek = new Date(currentWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                
                const weekText = `${startOfWeek.getFullYear()}ÎÖÑ ${startOfWeek.getMonth() + 1}Ïõî ${startOfWeek.getDate()}Ïùº ~ ${endOfWeek.getMonth() + 1}Ïõî ${endOfWeek.getDate()}Ïùº`;
                
                console.log('üîÑ Ï£ºÍ∞Ñ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏:', weekText);
                
                // current-week ÏöîÏÜå ÏóÖÎç∞Ïù¥Ìä∏
                const currentWeekElement = document.getElementById('current-week');
                if (currentWeekElement) {
                    currentWeekElement.textContent = weekText;
                    console.log('‚úÖ current-week ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                } else {
                    console.warn('‚ö†Ô∏è current-week ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                }
                
                // Ïù¥Ï†Ñ/Îã§Ïùå Ï£º Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                const today = new Date();
                const todayWeek = new Date(today);
                todayWeek.setDate(today.getDate() - today.getDay() + 1);
                
                const weeksDiff = Math.floor((currentWeek - todayWeek) / (7 * 24 * 60 * 60 * 1000));
                
                const prevWeekBtn = document.getElementById('prev-week');
                const nextWeekBtn = document.getElementById('next-week');
                
                if (prevWeekBtn) {
                    prevWeekBtn.disabled = weeksDiff <= -4; // 4Ï£º Ïù¥Ï†ÑÍπåÏßÄÎßå
                    console.log('‚úÖ prev-week Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                } else {
                    console.warn('‚ö†Ô∏è prev-week Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                }
                
                if (nextWeekBtn) {
                    nextWeekBtn.disabled = weeksDiff >= 4;  // 4Ï£º Ïù¥ÌõÑÍπåÏßÄÎßå
                    console.log('‚úÖ next-week Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                } else {
                    console.warn('‚ö†Ô∏è next-week Î≤ÑÌäºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                }
                
                // Ï£ºÍ∞Ñ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäºÎì§ÏùÑ Î≥¥Ïù¥Í≤å ÎßåÎì§Í∏∞
                const weekNavigation = document.querySelector('.week-navigation');
                if (weekNavigation) {
                    weekNavigation.style.display = 'flex';
                    console.log('‚úÖ Ï£ºÍ∞Ñ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÌëúÏãúÎê®');
                } else {
                    console.warn('‚ö†Ô∏è week-navigation ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                }
                
            } catch (error) {
                console.error('‚ùå updateWeekDisplay Ïò§Î•ò:', error);
            }
        }
        
        // ÌÖçÏä§Ìä∏Î•º Ïó¨Îü¨ Ïπ∏Ïóê ÎÇòÎàÑÏñ¥ ÌëúÏãú
        function splitTextForSlots(text, slotCount) {
            if (slotCount <= 1) return [text];
            
            const words = text.split(' ');
            
            if (words.length === 1) {
                const chars = text.split('');
                if (chars.length <= slotCount) {
                    return chars.concat(Array(slotCount - chars.length).fill(''));
                } else {
                    const charsPerSlot = Math.floor(chars.length / slotCount);
                    const remainder = chars.length % slotCount;
                    const result = [];
                    let start = 0;
                    
                    for (let i = 0; i < slotCount; i++) {
                        const end = start + charsPerSlot + (i < remainder ? 1 : 0);
                        result.push(chars.slice(start, end).join(''));
                        start = end;
                    }
                    return result;
                }
            } else if (words.length <= slotCount) {
                const result = [];
                for (let i = 0; i < slotCount; i++) {
                    result.push(i < words.length ? words[i] : '');
                }
                return result;
            } else {
                const wordsPerSlot = Math.floor(words.length / slotCount);
                const remainder = words.length % slotCount;
                const result = [];
                let start = 0;
                
                for (let i = 0; i < slotCount; i++) {
                    const end = start + wordsPerSlot + (i < remainder ? 1 : 0);
                    result.push(words.slice(start, end).join(' '));
                    start = end;
                }
                return result;
            }
        }

        // Google SheetsÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (API v4 ÏÇ¨Ïö©)
        async function fetchScheduleData() {
            try {
                const statusText = document.getElementById('status-text');
                statusText.textContent = 'üì° Google Sheets Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠ Ï§ë...';
                statusText.className = 'status-text status-warning';

                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RANGE}?key=${GOOGLE_SHEETS_API_KEY}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length === 0) {
                    throw new Error('ÏãúÌä∏Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§');
                }
                
                // Ìó§Îçî Ï†úÍ±∞ÌïòÍ≥† Îç∞Ïù¥ÌÑ∞Îßå ÏÇ¨Ïö©
                const scheduleData = data.values.slice(1);
                
                statusText.textContent = `‚úÖ Google Sheets Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å: ${scheduleData.length}Í∞ú ÏùºÏ†ï`;
                statusText.className = 'status-text status-success';
                
                return scheduleData;
            } catch (error) {
                console.error('Google Sheets Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
                const statusText = document.getElementById('status-text');
                statusText.textContent = `‚ùå Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: ${error.message}`;
                statusText.className = 'status-text status-error';
                return [];
            }
        }

        // ÏùºÏ†ï Îç∞Ïù¥ÌÑ∞Î•º ÏãúÍ∞ÑÌëú ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
        function processScheduleData(scheduleData) {
            const schedule = {};
            const memberMemos = { 'ÏïÑÎπ†': {}, 'ÏóÑÎßà': {}, 'Ïú§Îπà': {}, 'Ïú§Ï§Ä': {}, 'Í∞ÄÏ°±Í≥µÌÜµ': {} };
            
            // üö® Î∞òÎ≥µ ÏùºÏ†ï Ï§ëÎ≥µ Î∞©ÏßÄÎ•º ÏúÑÌïú Set
            const processedRepeatingEvents = new Set();
            
            // ÏòÅÏñ¥ ÏöîÏùºÏùÑ ÌïúÍµ≠Ïñ¥ ÏöîÏùºÎ°ú Î≥ÄÌôò
            const dayMapping = {
                'monday': 'ÏõîÏöîÏùº',
                'tuesday': 'ÌôîÏöîÏùº', 
                'wednesday': 'ÏàòÏöîÏùº',
                'thursday': 'Î™©ÏöîÏùº',
                'friday': 'Í∏àÏöîÏùº',
                'saturday': 'ÌÜ†ÏöîÏùº',
                'sunday': 'ÏùºÏöîÏùº'
            };
            
            scheduleData.forEach(row => {
                try {
                    if (row.length < 13) return; // 13Í∞ú Ïª¨Îüº (Date ÌïÑÎìú Ìè¨Ìï®)
                    
                    const [id, title, member, participants, dayFromSheet, date, startTime, endTime, category, priority, repeat, memo, created] = row;
                    
                    console.log(`üîç Ï≤òÎ¶¨ Ï§ë: ${title} (${member}) - ${dayFromSheet} ${startTime}-${endTime} - Date: ${date} - Î©îÎ™®: "${memo}"`);
                    
                    if (!title || !dayFromSheet || !startTime || !endTime) {
                        console.log(`‚ùå ÌïÑÏàò Îç∞Ïù¥ÌÑ∞ ÎàÑÎùΩ: ${title}`);
                        return;
                    }
                    
                    // üöÄ Î∞òÎ≥µ ÏùºÏ†ïÍ≥º Îã®Ïùº ÏùºÏ†ïÏùÑ Íµ¨Î∂ÑÌïòÏó¨ Ï≤òÎ¶¨
                    // 1. Î∞òÎ≥µ ÏùºÏ†ï: Day ÌïÑÎìú(ÏöîÏùº)Î•º Í∏∞Ï§ÄÏúºÎ°ú ÌòÑÏû¨ Ï£ºÏóê Ìï¥Îãπ ÏöîÏùºÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                    // 2. Îã®Ïùº ÏùºÏ†ï: Date ÌïÑÎìúÎ•º Í∏∞Ï§ÄÏúºÎ°ú ÌòÑÏû¨ Ï£ºÏóê Ìè¨Ìï®ÎêòÎäîÏßÄ ÌôïÏù∏
                    
                    const koreanDay = dayMapping[dayFromSheet.toLowerCase()];
                    if (!koreanDay) {
                        console.log(`‚ùå ÏöîÏùº Î≥ÄÌôò Ïã§Ìå®: ${dayFromSheet}`);
                        return;
                    }
                    
                    // Î∞òÎ≥µ ÏùºÏ†ïÏù∏ÏßÄ ÌôïÏù∏ (Repeat ÌïÑÎìúÍ∞Ä 'ÏóÜÏùå'Ïù¥ ÏïÑÎãàÍ≥†, Ïã§Ï†ú Î∞òÎ≥µ ÏÑ§Ï†ïÏù¥ ÏûàÎäî Í≤ΩÏö∞Îßå)
                    const isRepeatingEvent = repeat && repeat !== 'nan' && repeat.trim() !== '' && repeat.trim() !== 'ÏóÜÏùå';
                    
                    if (isRepeatingEvent) {
                        // üîÑ Î∞òÎ≥µ ÏùºÏ†ï: ÏöîÏùº Í∏∞Î∞òÏúºÎ°ú Ï≤òÎ¶¨ + ÎÇ†Ïßú Î≤îÏúÑ Ï≤¥ÌÅ¨
                        console.log(`üîÑ Î∞òÎ≥µ ÏùºÏ†ï Ï≤òÎ¶¨: ${title} (${koreanDay}) - Date: ${date}`);
                        
                        // üö® Î∞òÎ≥µ ÏùºÏ†ï Ï§ëÎ≥µ Î∞©ÏßÄ: ID Í∏∞Ï§ÄÏúºÎ°ú Ï≤òÎ¶¨ (Í∞Å Î∞òÎ≥µ ÏùºÏ†ïÏùÄ Í≥†Ïú† ID Î≥¥Ïú†)
                        const eventKey = `${id}`; // IDÎßåÏúºÎ°ú Ï§ëÎ≥µ Ï≤¥ÌÅ¨ (Í∞Å Î∞òÎ≥µ ÏùºÏ†ïÏùÄ Í≥†Ïú† ID)
                        if (processedRepeatingEvents.has(eventKey)) {
                            console.log(`‚è≠Ô∏è Î∞òÎ≥µ ÏùºÏ†ï Ï§ëÎ≥µ Í±¥ÎÑàÎõ∞Í∏∞: ${title} (${koreanDay}) - ID: ${id}`);
                            return;
                        }
                        processedRepeatingEvents.add(eventKey);
                        
                        // 1Ô∏è‚É£ Date ÌïÑÎìúÍ∞Ä ÏûàÏúºÎ©¥ Ìï¥Îãπ ÎÇ†ÏßúÎ•º Í∏∞Ï§ÄÏúºÎ°ú Ï≤¥ÌÅ¨ (Ïù¥ÎØ∏ Í≥ÑÏÇ∞Îêú Î∞òÎ≥µ ÏùºÏ†ï)
                        if (date && date !== 'nan' && date.toString().trim() !== '') {
                            try {
                                const eventDate = new Date(date);
                                const currentWeekStart = new Date(currentWeek);
                                const currentWeekEnd = new Date(currentWeek);
                                currentWeekEnd.setDate(currentWeekStart.getDate() + 6);
                                
                                // üö® Î∞òÎ≥µ ÏùºÏ†ï Ïú†Ìö® Î≤îÏúÑ Ï≤¥ÌÅ¨ (Ï≤´ Î≤àÏß∏ Ïò¨Î∞îÎ•∏ Î∞òÎ≥µÏùº Í∏∞Ï§Ä)
                                // ÏãúÏûëÏùº(8Ïõî 27Ïùº, ÏàòÏöîÏùº) Ïù¥ÌõÑ Ï≤´ Î≤àÏß∏ ÌôîÏöîÏùº = 9Ïõî 2Ïùº
                                const validRepeatStartDate = new Date('2025-09-02'); // Ï≤´ Î≤àÏß∏ Ïò¨Î∞îÎ•∏ Î∞òÎ≥µÏùº
                                const validRepeatEndDate = new Date('2025-11-20');
                                
                                if (eventDate < validRepeatStartDate) {
                                    console.log(`‚ùå Î∞òÎ≥µ ÏùºÏ†ï(ÎÇ†Ïßú Í∏∞Ï§Ä) Ï†úÏô∏: ${title} (${date}) - Ïú†Ìö® Î∞òÎ≥µ Î≤îÏúÑ Ïù¥Ï†Ñ (${validRepeatStartDate.toDateString()} Ïù¥Ï†Ñ)`);
                                    return;
                                } else if (eventDate > validRepeatEndDate) {
                                    console.log(`‚ùå Î∞òÎ≥µ ÏùºÏ†ï(ÎÇ†Ïßú Í∏∞Ï§Ä) Ï†úÏô∏: ${title} (${date}) - Ïú†Ìö® Î∞òÎ≥µ Î≤îÏúÑ Ïù¥ÌõÑ (${validRepeatEndDate.toDateString()} Ïù¥ÌõÑ)`);
                                    return;
                                }
                                
                                // ÌòÑÏû¨ Ï£º Î≤îÏúÑÏóê Ìè¨Ìï®ÎêòÏßÄ ÏïäÎäî ÏùºÏ†ïÏùÄ Ï†úÏô∏
                                if (eventDate < currentWeekStart || eventDate > currentWeekEnd) {
                                    console.log(`‚ùå Î∞òÎ≥µ ÏùºÏ†ï(ÎÇ†Ïßú Í∏∞Ï§Ä) Ï†úÏô∏: ${title} (${date}) - ÌòÑÏû¨ Ï£º: ${currentWeekStart.toDateString()} ~ ${currentWeekEnd.toDateString()}`);
                                    return;
                                } else {
                                    console.log(`‚úÖ Î∞òÎ≥µ ÏùºÏ†ï(ÎÇ†Ïßú Í∏∞Ï§Ä) Ìè¨Ìï®: ${title} (${date}) - ÌòÑÏû¨ Ï£º: ${currentWeekStart.toDateString()} ~ ${currentWeekEnd.toDateString()}`);
                                }
                            } catch (error) {
                                console.warn(`‚ö†Ô∏è Î∞òÎ≥µ ÏùºÏ†ï ÎÇ†Ïßú ÌååÏã± Ïã§Ìå®: ${date}`, error);
                                return;
                            }
                        } else {
                            // 2Ô∏è‚É£ Date ÌïÑÎìúÍ∞Ä ÏóÜÏúºÎ©¥ ÏöîÏùº Í∏∞Ï§Ä + Î∞òÎ≥µ Î≤îÏúÑ Ï≤¥ÌÅ¨
                            const currentWeekStart = new Date(currentWeek);
                            const currentWeekEnd = new Date(currentWeek);
                            currentWeekEnd.setDate(currentWeekStart.getDate() + 6);
                            
                            // ÏöîÏùºÏùÑ Ïà´ÏûêÎ°ú Î≥ÄÌôò (0=ÏùºÏöîÏùº, 1=ÏõîÏöîÏùº, ..., 6=ÌÜ†ÏöîÏùº)
                            const dayNumbers = { 'ÏõîÏöîÏùº': 1, 'ÌôîÏöîÏùº': 2, 'ÏàòÏöîÏùº': 3, 'Î™©ÏöîÏùº': 4, 'Í∏àÏöîÏùº': 5, 'ÌÜ†ÏöîÏùº': 6, 'ÏùºÏöîÏùº': 0 };
                            const eventDayNumber = dayNumbers[koreanDay];
                            
                            if (eventDayNumber !== undefined) {
                                // ÌòÑÏû¨ Ï£ºÏùò Ìï¥Îãπ ÏöîÏùº ÎÇ†Ïßú Í≥ÑÏÇ∞
                                const currentDay = new Date(currentWeek);
                                currentDay.setDate(currentWeek.getDate() + eventDayNumber - 1);
                                
                                // Î∞òÎ≥µ ÏùºÏ†ï Î≤îÏúÑ ÏÑ§Ï†ï (ManagerÏôÄ ÎèôÏùºÌïú Î≤îÏúÑ)
                                const repeatStartDate = new Date('2025-09-02'); // Ï≤´ Î≤àÏß∏ Ïò¨Î∞îÎ•∏ Î∞òÎ≥µÏùº
                                const repeatEndDate = new Date('2025-11-20');
                                
                                // ÌòÑÏû¨ Ï£ºÏùò Ìï¥Îãπ ÏöîÏùºÏù¥ Î∞òÎ≥µ Î≤îÏúÑ ÎÇ¥Ïóê ÏûàÎäîÏßÄ Ï≤¥ÌÅ¨
                                if (currentDay >= repeatStartDate && currentDay <= repeatEndDate && 
                                    currentDay >= currentWeekStart && currentDay <= currentWeekEnd) {
                                    console.log(`‚úÖ Î∞òÎ≥µ ÏùºÏ†ï(ÏöîÏùº Í∏∞Ï§Ä) Ìè¨Ìï®: ${title} (${koreanDay}) - ${currentDay.toDateString()} - Î∞òÎ≥µ Î≤îÏúÑ ÎÇ¥`);
                                } else {
                                    if (currentDay < repeatStartDate || currentDay > repeatEndDate) {
                                        console.log(`‚ùå Î∞òÎ≥µ ÏùºÏ†ï(ÏöîÏùº Í∏∞Ï§Ä) Ï†úÏô∏: ${title} (${koreanDay}) - ${currentDay.toDateString()} - Î∞òÎ≥µ Î≤îÏúÑ Î∞ñ (${repeatStartDate.toDateString()} ~ ${repeatEndDate.toDateString()})`);
                                    } else {
                                        console.log(`‚ùå Î∞òÎ≥µ ÏùºÏ†ï(ÏöîÏùº Í∏∞Ï§Ä) Ï†úÏô∏: ${title} (${koreanDay}) - ${currentDay.toDateString()} - ÌòÑÏû¨ Ï£º Î≤îÏúÑ Î∞ñ`);
                                    }
                                    return;
                                }
                            }
                        }
                    } else {
                        // üìÖ Îã®Ïùº ÏùºÏ†ï: Date ÌïÑÎìú Í∏∞Î∞òÏúºÎ°ú Ï≤òÎ¶¨
                        if (date && date !== 'nan' && date.toString().trim() !== '') {
                            try {
                                const eventDate = new Date(date);
                                const currentWeekStart = new Date(currentWeek);
                                const currentWeekEnd = new Date(currentWeek);
                                currentWeekEnd.setDate(currentWeekStart.getDate() + 6);
                                
                                // ÌòÑÏû¨ Ï£º Î≤îÏúÑÏóê Ìè¨Ìï®ÎêòÏßÄ ÏïäÎäî ÏùºÏ†ïÏùÄ Ï†úÏô∏
                                if (eventDate < currentWeekStart || eventDate > currentWeekEnd) {
                                    console.log(`‚ùå Îã®Ïùº ÏùºÏ†ï Ï†úÏô∏: ${title} (${date}) - ÌòÑÏû¨ Ï£º: ${currentWeekStart.toDateString()} ~ ${currentWeekEnd.toDateString()}`);
                                    return;
                                } else {
                                    console.log(`‚úÖ Îã®Ïùº ÏùºÏ†ï Ìè¨Ìï®: ${title} (${date}) - ÌòÑÏû¨ Ï£º: ${currentWeekStart.toDateString()} ~ ${currentWeekEnd.toDateString()}`);
                                }
                    } catch (error) {
                                console.warn(`‚ö†Ô∏è ÎÇ†Ïßú ÌååÏã± Ïã§Ìå®: ${date}`, error);
                                return;
                            }
                        } else {
                            console.log(`‚ö†Ô∏è Îã®Ïùº ÏùºÏ†ïÏù∏Îç∞ Date ÌïÑÎìú ÏóÜÏùå: ${title}`);
                            return;
                        }
                    }
                    
                    console.log(`‚úÖ ÏùºÏ†ï Ìè¨Ìï®: ${title} (${koreanDay}) - Date: ${date}`);
                    
                    // ÏòÅÏñ¥ ÏöîÏùºÏùÑ ÌïúÍµ≠Ïñ¥Î°ú Î≥ÄÌôò (Ïù¥ÎØ∏ ÏúÑÏóêÏÑú Ï≤òÎ¶¨Îê®)
                    
                    console.log(`‚úÖ ÏùºÏ†ï Ìè¨Ìï®: ${title} (${koreanDay}) - Date: ${date}`);
                    
                    const startSlot = timeToSlot(startTime);
                    const endSlot = timeToSlot(endTime);
                    
                    if (startSlot === null || endSlot === null) {
                        console.log(`‚ùå ÏãúÍ∞Ñ Ïä¨Î°Ø Î≥ÄÌôò Ïã§Ìå®: ${startTime} -> ${startSlot}, ${endTime} -> ${endSlot}`);
                        return;
                    }
                    
                    console.log(`‚úÖ Ïä¨Î°Ø Î≥ÄÌôò ÏÑ±Í≥µ: ${startTime}(${startSlot}) - ${endTime}(${endSlot})`);
                    
                    // Î©îÎ™® ÏàòÏßë (Îπà Î¨∏ÏûêÏó¥ÎèÑ Ï≤òÎ¶¨)
                    if (memo && memo !== 'nan' && memo.trim() !== '') {
                        console.log(`üìù Î©îÎ™® Î∞úÍ≤¨: ${member} - ${koreanDay} - "${memo}"`);
                        
                        // Í∞ÄÏ°±Í≥µÌÜµ Î©îÎ™®Îäî Í∞ÄÏ°±Í≥µÌÜµÏóêÍ≤åÎßå Ï∂îÍ∞Ä
                        if (member === 'Í∞ÄÏ°±Í≥µÌÜµ') {
                            if (!memberMemos['Í∞ÄÏ°±Í≥µÌÜµ'][koreanDay]) {
                                memberMemos['Í∞ÄÏ°±Í≥µÌÜµ'][koreanDay] = [];
                            }
                            memberMemos['Í∞ÄÏ°±Í≥µÌÜµ'][koreanDay].push(memo);
                            console.log(`üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Í∞ÄÏ°±Í≥µÌÜµ Î©îÎ™® Ï∂îÍ∞Ä: Í∞ÄÏ°±Í≥µÌÜµ - ${koreanDay}`);
                        } else if (member in memberMemos) {
                            if (!memberMemos[member][koreanDay]) {
                                memberMemos[member][koreanDay] = [];
                            }
                            memberMemos[member][koreanDay].push(memo);
                            console.log(`‚úÖ Í∞úÏù∏ Î©îÎ™® Ï∂îÍ∞Ä: ${member} - ${koreanDay} - "${memo}"`);
                        }
                    } else {
                        console.log(`üìù Î©îÎ™® ÏóÜÏùå: ${member} - ${koreanDay}`);
                    }
                    
                    // Ï∞∏ÏÑùÏûê Ï†ïÎ≥¥ Ï≤òÎ¶¨
                    let mainPerson = member;
                    let membersToAdd = [member];
                    
                    if (member === 'Í∞ÄÏ°±Í≥µÌÜµ') {
                        mainPerson = 'Í∞ÄÏ°±Í≥µÌÜµ';
                        membersToAdd = familyMembers;
                    } else if (participants && participants !== 'nan') {
                        const participantList = participants.split(',').map(p => p.trim());
                        if (participantList.length > 1) {
                            membersToAdd = participantList;
                        }
                    }
                    
                    const duration = endSlot - startSlot;
                    const splitTexts = splitTextForSlots(title, duration);
                    
                    membersToAdd.forEach(memberName => {
                        if (familyMembers.includes(memberName) || memberName === 'Í∞ÄÏ°±Í≥µÌÜµ') {
                            for (let slot = startSlot; slot < endSlot; slot++) {
                                if (slot < 0) continue;
                                
                                if (!schedule[koreanDay]) schedule[koreanDay] = {};
                                if (!schedule[koreanDay][slot]) schedule[koreanDay][slot] = {};
                                
                                const barType = slot === startSlot && slot === endSlot - 1 ? 'single' :
                                              slot === startSlot ? 'start' :
                                              slot === endSlot - 1 ? 'end' : 'middle';
                                
                                const slotPosition = slot - startSlot;
                                const slotText = splitTexts[slotPosition] || '';
                                
                                schedule[koreanDay][slot][memberName] = {
                                    title: title,
                                    slotText: slotText,
                                    person: member,
                                    mainPerson: mainPerson,
                                    participants: participants,
                                    class: getEventColorClass(mainPerson, participants),
                                    barType: barType,
                                    duration: duration,
                                    isFamily: member === 'Í∞ÄÏ°±Í≥µÌÜµ',
                                    isMulti: participants && participants !== 'nan' && participants.split(',').length > 1
                                };
                            }
                        }
                    });
                } catch (error) {
                    console.error('ÏùºÏ†ï Ï≤òÎ¶¨ Ïò§Î•ò:', error);
                }
            });
            
            return { schedule, memberMemos };
        }

        // ÏùºÏ†ï ÏÉâÏÉÅ ÌÅ¥ÎûòÏä§ Í≤∞Ï†ï
        function getEventColorClass(mainPerson, participants) {
            if (mainPerson === 'Í∞ÄÏ°±Í≥µÌÜµ') {
                return 'family-common';
            } else if (participants && participants !== 'nan' && participants.split(',').length > 1) {
                return 'multi-participant';
                    } else {
                return memberColors[mainPerson] || 'dad-bar';
            }
        }

        // ÏãúÍ∞ÑÌëú HTML ÏÉùÏÑ±
        function generateTimetableHTML(schedule, memberMemos) {
            const timeSlots = generateTimeSlots();
            const days = ['ÏõîÏöîÏùº', 'ÌôîÏöîÏùº', 'ÏàòÏöîÏùº', 'Î™©ÏöîÏùº', 'Í∏àÏöîÏùº', 'ÌÜ†ÏöîÏùº', 'ÏùºÏöîÏùº'];
            const dayAbbr = ['Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†', 'Ïùº'];
            
            // Ìó§Îçî ÏÉùÏÑ± (currentWeek ÏÇ¨Ïö©)
            const monday = new Date(currentWeek);
            
            let headerRow = '<tr><th class="time-col">ÏãúÍ∞Ñ</th>';
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                headerRow += `<th>${days[i]}<br><small>${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}</small></th>`;
            }
            headerRow += '</tr>';
            
            // ÏãúÍ∞ÑÌëú Ìñâ ÏÉùÏÑ±
            let tableRows = '';
            timeSlots.forEach((timeStr, slotIdx) => {
                const isHour = timeStr.endsWith(':00');
                const hourClass = isHour ? 'hour-line' : '';
                const timeDisplay = isHour ? `<strong>${timeStr}</strong>` : timeStr;
                
                let rowHtml = `<tr><td class="time-col ${hourClass}">${timeDisplay}</td>`;
                
                for (let dayIdx = 0; dayIdx < 7; dayIdx++) {
                    const currentDay = days[dayIdx];
                    let cellContent = '<div class="time-slot">';
                    
                    // 4Í∞ú Í≥†Ï†ï Ïπ∏ ÏÉùÏÑ±
                    familyMembers.forEach((member, i) => {
                        const leftPosition = `${i * 25}%`;
                        const width = "24%";
                        
                        const event = schedule[currentDay] && schedule[currentDay][slotIdx] && schedule[currentDay][slotIdx][member];
                        
                        if (event) {
                            const duration = event.duration;
                            const slotText = event.slotText;
                            
                            let textSpan = '';
                            if (slotText.trim()) {
                                textSpan = `<span class="event-text large-text" style="font-size: 13px;">${slotText}</span>`;
                            }
                            
                            let specialClass = '';
                            if (event.isFamily) {
                                specialClass = 'family-common';
                            } else if (event.isMulti) {
                                specialClass = 'multi-participant';
                            }
                            
                            cellContent += `
                            <div class="event-bar ${event.class} bar-${event.barType} ${specialClass}" 
                                 style="left: ${leftPosition}; width: ${width};"
                                 data-member="${member}"
                                 data-duration="${duration}">
                                ${textSpan}
                            </div>`;
                        } else {
                            cellContent += `
                            <div class="empty-slot" 
                                 style="left: ${leftPosition}; width: ${width};"
                                 data-member="${member}">
                            </div>`;
                        }
                    });
                    
                    cellContent += '</div>';
                    rowHtml += `<td>${cellContent}</td>`;
                }
                
                rowHtml += '</tr>';
                tableRows += rowHtml;
            });
            
            return { headerRow, tableRows };
        }

        // Ï£ºÍ∞Ñ Î©îÎ™® ÏÉùÏÑ±
        function generateWeeklyMemo(memberMemos) {
            let memoHtml = '';
            
            // Í∞ÄÏ°±Í≥µÌÜµ Î©îÎ™® Î®ºÏ†Ä ÌëúÏãú
            if (memberMemos['Í∞ÄÏ°±Í≥µÌÜµ']) {
                const icon = 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
                const colorClass = 'family-common';
                
                const memoItems = [];
                const days = ['ÏõîÏöîÏùº', 'ÌôîÏöîÏùº', 'ÏàòÏöîÏùº', 'Î™©ÏöîÏùº', 'Í∏àÏöîÏùº', 'ÌÜ†ÏöîÏùº', 'ÏùºÏöîÏùº'];
                
                days.forEach(day => {
                    if (memberMemos['Í∞ÄÏ°±Í≥µÌÜµ'][day] && memberMemos['Í∞ÄÏ°±Í≥µÌÜµ'][day].length > 0) {
                        const uniqueMemos = [...new Set(memberMemos['Í∞ÄÏ°±Í≥µÌÜµ'][day])];
                        let memoText = uniqueMemos[0].substring(0, 30);
                        
                        // Îã®Ïñ¥ Îã®ÏúÑÎ°ú ÏûêÏó∞Ïä§ÎüΩÍ≤å ÏûêÎ•¥Í∏∞ (25ÏûêÏóêÏÑú Îã®Ïñ¥ Í≤ΩÍ≥Ñ)
                        if (memoText.length >= 25) {
                            const lastSpace = memoText.lastIndexOf(' ', 25);
                            if (lastSpace > 15) {
                                memoText = memoText.substring(0, lastSpace) + "..";
                            } else {
                                memoText = memoText.substring(0, 25) + "..";
                            }
                        }
                        
                        // ÏöîÏùº ÌëúÏãú Îã®Ï∂ï: "Î™©ÏöîÏùº:" ‚Üí "Î™©:"
                        const shortDay = day.substring(0, 1);
                        memoItems.push(`${shortDay}: ${memoText}`);
                    }
                });
                
                const displayMemos = memoItems.slice(0, 4); // 3Í∞ú ‚Üí 4Í∞úÎ°ú Ï¶ùÍ∞Ä
                if (memoItems.length > 4) {
                    displayMemos.push(`Ïô∏ ${memoItems.length - 4}Í∞ú`);
                }
                
                // "‚Ä¢ " Íµ¨Î∂ÑÏûêÎ°ú Î≥ÄÍ≤ΩÌïòÍ≥† Ï§ÑÎ∞îÍøà Ï∂îÍ∞Ä
                const memoText = displayMemos.length > 0 ? displayMemos.map(memo => `‚Ä¢ ${memo}`).join("<br>") : "üìå ÌäπÎ≥Ñ Ï§ÄÎπÑÏÇ¨Ìï≠ ÏóÜÏùå";
                
                memoHtml += `
                <div class="member-memo">
                    <div class="memo-header">
                        <div class="color-box ${colorClass}"></div>
                        <span class="member-name">${icon} Í∞ÄÏ°±Í≥µÌÜµ</span>
                    </div>
                    <div class="memo-content">${memoText}</div>
                </div>`;
            }
            
            familyMembers.forEach(member => {
                const icon = memberIcons[member];
                const colorClass = memberColors[member];
                
                const memoItems = [];
                const days = ['ÏõîÏöîÏùº', 'ÌôîÏöîÏùº', 'ÏàòÏöîÏùº', 'Î™©ÏöîÏùº', 'Í∏àÏöîÏùº', 'ÌÜ†ÏöîÏùº', 'ÏùºÏöîÏùº'];
                
                days.forEach(day => {
                    if (memberMemos[member][day] && memberMemos[member][day].length > 0) {
                        const uniqueMemos = [...new Set(memberMemos[member][day])];
                        const familyMemo = uniqueMemos.find(memo => memo.includes('[Í∞ÄÏ°±]'));
                        
                        let memoText;
                        if (familyMemo) {
                            memoText = familyMemo.replace('[Í∞ÄÏ°±] ', '').substring(0, 30);
                        } else {
                            memoText = uniqueMemos[0].substring(0, 30);
                        }
                        
                        // Îã®Ïñ¥ Îã®ÏúÑÎ°ú ÏûêÏó∞Ïä§ÎüΩÍ≤å ÏûêÎ•¥Í∏∞ (25ÏûêÏóêÏÑú Îã®Ïñ¥ Í≤ΩÍ≥Ñ)
                        if (memoText.length >= 25) {
                            const lastSpace = memoText.lastIndexOf(' ', 25);
                            if (lastSpace > 15) {
                                memoText = memoText.substring(0, lastSpace) + "..";
                            } else {
                                memoText = memoText.substring(0, 25) + "..";
                            }
                        }
                        
                        // ÏöîÏùº ÌëúÏãú Îã®Ï∂ï: "Î™©ÏöîÏùº:" ‚Üí "Î™©:"
                        const shortDay = day.substring(0, 1);
                        memoItems.push(`${shortDay}: ${memoText}`);
                    }
                });
                
                const displayMemos = memoItems.slice(0, 4); // 3Í∞ú ‚Üí 4Í∞úÎ°ú Ï¶ùÍ∞Ä
                if (memoItems.length > 4) {
                    displayMemos.push(`Ïô∏ ${memoItems.length - 4}Í∞ú`);
                }
                
                // "‚Ä¢ " Íµ¨Î∂ÑÏûêÎ°ú Î≥ÄÍ≤ΩÌïòÍ≥† Ï§ÑÎ∞îÍøà Ï∂îÍ∞Ä
                const memoText = displayMemos.length > 0 ? displayMemos.map(memo => `‚Ä¢ ${memo}`).join("<br>") : "üìå ÌäπÎ≥Ñ Ï§ÄÎπÑÏÇ¨Ìï≠ ÏóÜÏùå";
                
                memoHtml += `
                <div class="member-memo">
                    <div class="memo-header">
                        <div class="color-box ${colorClass}"></div>
                        <span class="member-name">${icon} ${member}</span>
                    </div>
                    <div class="memo-content">${memoText}</div>
                </div>`;
            });
            
            return memoHtml;
        }

        // ÏãúÍ∞ÑÌëú ÏóÖÎç∞Ïù¥Ìä∏ (ÏïàÏ†ÑÌïú DOM Ï°∞Ïûë)
        async function updateTimetable() {
            try {
                console.log('üîÑ ÏãúÍ∞ÑÌëú ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë...');
                
                const scheduleData = await fetchScheduleData();
                if (scheduleData.length === 0) {
                    throw new Error('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§');
                }
                
                console.log(`üìä ${scheduleData.length}Í∞úÏùò ÏùºÏ†ï Îç∞Ïù¥ÌÑ∞ Î°úÎìúÎê®`);
                
                const { schedule, memberMemos } = processScheduleData(scheduleData);
                console.log('‚úÖ ÏùºÏ†ï Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ ÏôÑÎ£å');
                
                const { headerRow, tableRows } = generateTimetableHTML(schedule, memberMemos);
                const memoHtml = generateWeeklyMemo(memberMemos);
                
                // DOM ÏóÖÎç∞Ïù¥Ìä∏ (ÏïàÏ†ÑÌïú Ï°∞Ïûë)
                const timetableElement = document.getElementById('timetable');
                if (timetableElement) {
                    timetableElement.innerHTML = `
                        <table>
                            <thead>${headerRow}</thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    `;
                    console.log('‚úÖ ÏãúÍ∞ÑÌëú DOM ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                } else {
                    console.warn('‚ö†Ô∏è timetable ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                }
                
                const memoContentElement = document.getElementById('memo-content');
                if (memoContentElement) {
                    memoContentElement.innerHTML = memoHtml;
                    console.log('‚úÖ Î©îÎ™® DOM ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                } else {
                    console.warn('‚ö†Ô∏è memo-content ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                }
                
                // Ï£ºÍ∞Ñ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ (currentWeek ÏÇ¨Ïö©)
                updateWeekDisplay();
                
                // ÌòÑÏû¨ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                const updateTimeElement = document.getElementById('update-time');
                if (updateTimeElement) {
                    const today = new Date();
                    updateTimeElement.textContent = today.toLocaleString('ko-KR', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    console.log('‚úÖ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÍ∞Ñ ÌëúÏãú ÏôÑÎ£å');
                } else {
                    console.warn('‚ö†Ô∏è update-time ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                }
                
                const statusText = document.getElementById('status-text');
                if (statusText) {
                    statusText.textContent = '‚úÖ ÏãúÍ∞ÑÌëú ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å';
                    statusText.className = 'status-text status-success';
                    
                    setTimeout(() => {
                        statusText.textContent = 'üì± Í∞ÄÏ°± ÏãúÍ∞ÑÌëú';
                        statusText.className = 'status-text';
                    }, 2000);
                    console.log('‚úÖ ÏÉÅÌÉú ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
                } else {
                    console.warn('‚ö†Ô∏è status-text ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
                }
                
                console.log('üéâ ÏãúÍ∞ÑÌëú ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å!');
                
            } catch (error) {
                console.error('‚ùå ÏãúÍ∞ÑÌëú ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', error);
                const statusText = document.getElementById('status-text');
                if (statusText) {
                    statusText.textContent = `‚ùå ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®: ${error.message}`;
                    statusText.className = 'status-text status-error';
                }
            }
        }

        // ÏÉàÎ°úÍ≥†Ïπ® Ìï®Ïàò
        function refreshSchedule() {
            const statusText = document.getElementById('status-text');
            statusText.textContent = 'üîÑ ÏÉàÎ°úÍ≥†Ïπ® Ï§ë...';
            statusText.className = 'status-text status-warning';
            
            setTimeout(() => {
                updateTimetable();
            }, 500);
        }

        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏãúÍ∞ÑÌëú ÏÉùÏÑ±
        window.addEventListener('load', () => {
            console.log('üöÄ ÌéòÏù¥ÏßÄ Î°úÎìúÎê® - Ï¥àÍ∏∞Ìôî ÏãúÏûë');
            
            // PWA Service Worker Îì±Î°ù
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('‚úÖ PWA Service Worker Îì±Î°ù ÏôÑÎ£å:', registration.scope);
                    })
                    .catch(error => {
                        console.log('‚ùå PWA Service Worker Îì±Î°ù Ïã§Ìå®:', error);
                    });
            }
            
            // PWA ÏÑ§Ïπò ÌîÑÎ°¨ÌîÑÌä∏ Ï≤òÎ¶¨
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log('üì± PWA ÏÑ§Ïπò Í∞ÄÎä•!');
                
                // ÏÑ§Ïπò ÏïåÎ¶º ÌëúÏãú
                showInstallNotification();
            });
            
            // Ï£ºÍ∞Ñ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            if (typeof updateWeekDisplay === 'function') {
                updateWeekDisplay();
                console.log('‚úÖ Ï¥àÍ∏∞ Ï£ºÍ∞Ñ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å');
            } else {
                console.warn('‚ö†Ô∏è updateWeekDisplay Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
            }
            
            // ÏãúÍ∞ÑÌëú ÏóÖÎç∞Ïù¥Ìä∏
            if (typeof updateTimetable === 'function') {
                updateTimetable();
                console.log('‚úÖ Ï¥àÍ∏∞ ÏãúÍ∞ÑÌëú ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë');
            } else {
                console.warn('‚ö†Ô∏è updateTimetable Ìï®ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏùå');
            }
        });

        // PWA ÏÑ§Ïπò ÏïåÎ¶º ÌëúÏãú
        function showInstallNotification() {
            // Ïù¥ÎØ∏ ÏÑ§ÏπòÎêòÏñ¥ ÏûàÏúºÎ©¥ ÌëúÏãúÌïòÏßÄ ÏïäÏùå
            if (window.matchMedia('(display-mode: standalone)').matches) {
                console.log('‚úÖ PWA Ïù¥ÎØ∏ ÏÑ§ÏπòÎê®');
                return;
            }
            
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="
                    position: fixed; 
                    bottom: 20px; 
                    left: 20px; 
                    right: 20px; 
                    background: #6366f1; 
                    color: white; 
                    padding: 15px; 
                    border-radius: 10px; 
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 2000;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    max-width: 400px;
                    margin: 0 auto;
                    animation: slideUp 0.3s ease;
                ">
                    <div>
                        <div style="font-weight: bold; margin-bottom: 4px;">üì± Ïï±ÏúºÎ°ú ÏÑ§ÏπòÌïòÍ∏∞</div>
                        <div style="font-size: 14px; opacity: 0.9;">Ìôà ÌôîÎ©¥Ïóê Ï∂îÍ∞ÄÌï¥ÏÑú Îπ†Î•¥Í≤å Ï†ëÍ∑ºÌïòÏÑ∏Ïöî!</div>
                    </div>
                    <button id="install-btn" style="
                        background: rgba(255,255,255,0.2); 
                        border: 1px solid rgba(255,255,255,0.3); 
                        color: white; 
                        padding: 8px 16px; 
                        border-radius: 6px; 
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: bold;
                    ">ÏÑ§Ïπò</button>
                    <button id="dismiss-btn" style="
                        background: none; 
                        border: none; 
                        color: rgba(255,255,255,0.7); 
                        cursor: pointer; 
                        font-size: 18px;
                        margin-left: 10px;
                    ">√ó</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // ÏÑ§Ïπò Î≤ÑÌäº Ïù¥Î≤§Ìä∏
            document.getElementById('install-btn').addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('‚úÖ PWA ÏÑ§Ïπò ÏôÑÎ£å');
                        }
                        deferredPrompt = null;
                    });
                }
                notification.remove();
            });
            
            // Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏
            document.getElementById('dismiss-btn').addEventListener('click', () => {
                notification.remove();
            });
            
            // 5Ï¥à ÌõÑ ÏûêÎèô Ïà®ÍπÄ
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 8000);
        }

        // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú ÎÖ∏Ï∂ú
        window.refreshSchedule = refreshSchedule;
    </script>
</body>
</html>